generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===========================
 * ENUMS
 * ===========================
 */

enum Rol {
  SUPERADMIN
  ADMIN
  DOCENTE
  ESTUDIANTE
}




/**
 * ===========================
 * USUARIO
 * ===========================
 * Identidad + rol + progreso + chat
 */
model Usuario {
  id                 Int      @id @default(autoincrement())
  documentoIdentidad String   @unique
  nombre             String
  correo             String   @unique
  contrasena         String
  rol                Rol

  activo             Boolean  @default(true)
  lastLoginDate      DateTime?
  creadoEn           DateTime @default(now())
  actualizadoEn      DateTime @updatedAt

  // Relaciones
  materialesCreados  Material[]
  modulosCreados     Modulo[]
  progresos          Progreso[]
  sesionesChat       ChatSession[]
}

/**
 * ===========================
 * MATERIAL TÉCNICO (PDF / DOC)
 * ===========================
 * Fuente única de verdad
 */
model Material {
  id          Int      @id @default(autoincrement())
  titulo      String
  descripcion String?
  tipo        String
  url         String
  creadoEn    DateTime @default(now())

  creadoPorId Int
  creadoPor   Usuario @relation(fields: [creadoPorId], references: [id], onDelete: Cascade)

  // Relaciones
  modulos     ModuloMaterial[]
}

/**
 * ===========================
 * MÓDULO DE APRENDIZAJE
 * ===========================
 * Guía pedagógica del material
 */
model Modulo {
  id        Int      @id @default(autoincrement())
  titulo    String
  contenido String
  orden     Int
  creadoEn  DateTime @default(now())

  creadoPorId Int
  creadoPor   Usuario @relation(fields: [creadoPorId], references: [id])

  // Relaciones
  materiales ModuloMaterial[]
  progresos  Progreso[]
  chats      ChatSession[]
}

/**
 * ===========================
 * RELACIÓN MÓDULO ↔ MATERIAL
 * ===========================
 * N:M — un material puede usarse en varios módulos
 */
model ModuloMaterial {
  id         Int @id @default(autoincrement())
  moduloId   Int
  materialId Int

  modulo   Modulo   @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([moduloId, materialId])
}

/**
 * ===========================
 * PROGRESO DEL ESTUDIANTE
 * ===========================
 * Controla avance por módulo
 */
model Progreso {
  id        Int @id @default(autoincrement())
  usuarioId Int
  moduloId  Int

  completado Boolean  @default(false)
  puntaje    Int?
  actualizadoEn DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  modulo  Modulo  @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, moduloId])
}

/**
 * ===========================
 * CHAT DEL TUTOR VIRTUAL
 * ===========================
 * Contextualizado por módulo
 */
model ChatSession {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  moduloId  Int
  mensajes  Json
  creadoEn  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  modulo  Modulo  @relation(fields: [moduloId], references: [id], onDelete: Cascade)
}
