generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===========================
 * ENUMS
 * ===========================
 */

enum Rol {
  SUPERADMIN
  ADMIN
  DOCENTE
  ESTUDIANTE
}

/**
 * ===========================
 * USUARIOS
 * ===========================
 */

model Usuario {
  id                 Int    @id @default(autoincrement())
  documentoIdentidad String @unique
  nombre             String
  correo             String @unique
  contrasena         String
  rol                Rol

  telefono      String?
  xp            Int      @default(0)
  streak        Int      @default(0)
  lastLoginDate DateTime @default(now())
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  asignaturasCreadas Asignatura[]   @relation("DocenteAsignaturas")
  estudiantes        Estudiante[]
  recordatorios      Recordatorio[]

  // ðŸ”½ ESTE CAMPO FALTABA
  modulosCreados Modulo[]

  progresos    Progreso[]
  sesionesChat ChatSession[]
}

/**
 * ===========================
 * ESTUDIANTE
 * ===========================
 */

model Estudiante {
  id                 Int    @id @default(autoincrement())
  documentoIdentidad String @unique
  nombre             String
  carrera            String
  correo             String @unique
  contrasena         String

  usuarioId    Int
  asignaturaId Int

  asignatura Asignatura @relation(fields: [asignaturaId], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * ASIGNATURA
 * ===========================
 */

model Asignatura {
  id      Int     @id @default(autoincrement())
  nombre  String
  carrera String
  jornada String
  activo  Boolean @default(true)

  idDocente Int
  docente   Usuario @relation("DocenteAsignaturas", fields: [idDocente], references: [id])

  enlaceRegistro  String?   @unique
  fechaExpiracion DateTime?

  estudiantes   Estudiante[]
  materiales    Material[]
  eventos       Evento[]
  recordatorios Recordatorio[]
}

/**
 * ===========================
 * MATERIAL
 * ===========================
 */

model Material {
  id       Int      @id @default(autoincrement())
  nombre   String
  tipo     String
  url      String
  creadoEn DateTime @default(now())

  asignaturaId Int
  asignatura   Asignatura @relation(fields: [asignaturaId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * EVENTO
 * ===========================
 */

model Evento {
  id          Int      @id @default(autoincrement())
  titulo      String
  descripcion String
  fecha       DateTime
  publicado   Boolean  @default(false)

  asignaturaId Int
  asignatura   Asignatura @relation(fields: [asignaturaId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * RECORDATORIO
 * ===========================
 */

model Recordatorio {
  id          Int      @id @default(autoincrement())
  titulo      String
  descripcion String
  fecha       DateTime
  importancia String

  asignaturaId Int
  creadoPorId  Int

  asignatura Asignatura @relation(fields: [asignaturaId], references: [id], onDelete: Cascade)
  creadoPor  Usuario    @relation(fields: [creadoPorId], references: [id], onDelete: Cascade)
}

/**
 * ===========================
 * MODULO DE APRENDIZAJE
 * ===========================
 */

model Modulo {
  id        Int      @id @default(autoincrement())
  titulo    String
  contenido String
  orden     Int
  creadoEn  DateTime @default(now())

  creadoPor Int
  autor     Usuario @relation(fields: [creadoPor], references: [id])

  progresos Progreso[]
}

/**
 * ===========================
 * PROGRESO DEL ESTUDIANTE
 * ===========================
 */

model Progreso {
  id        Int @id @default(autoincrement())
  usuarioId Int
  moduloId  Int

  completado    Boolean  @default(false)
  puntaje       Int?
  actualizadoEn DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  modulo  Modulo  @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, moduloId])
}

/**
 * ===========================
 * CHATBOT
 * ===========================
 */

model ChatSession {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  mensajes  Json
  creadoEn  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}
